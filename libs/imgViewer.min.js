/*! jQuery imgViewer - v0.6.0 - 2013-06-06
* https://github.com/waynegm/imgViewer
* Copyright (c) 2013 Wayne Mogg; Licensed MIT */
(function(t){t.widget("wgm.imgViewer",{options:{zoomStep:.1,zoom:1,onClick:null,onUpdate:null},_create:function(){var e=this;this.element.is("img")||t.error("imgviewer plugin can only be applied to img elements"),e.img=e.element[0];var i=t(e.img);e.zimg=t("<img/>",{src:e.img.src}).appendTo("body").wrap("<div class='viewport'/>");var o=t(e.zimg);e.view=t(e.zimg).parent();var n=t(e.view);e.vCenter={},e.dragging=!1,e.ready=!1,i.one("load",function(){e.ready=!0;var t=i.width(),s=i.height(),r=i.offset();e.offsetPadding={top:parseInt(i.css("padding-top"),10),left:parseInt(i.css("padding-left"),10),right:parseInt(i.css("padding-right"),10),bottom:parseInt(i.css("padding-bottom"),10)},e.offsetBorder={x:Math.round((i.outerWidth()-i.innerWidth())/2),y:Math.round((i.outerHeight()-i.innerHeight())/2)};var h=r.top+e.offsetBorder.y+e.offsetPadding.top,p=r.left+e.offsetBorder.x+e.offsetPadding.left;n.css({position:"absolute",overflow:"hidden",top:h+"px",left:p+"px",width:t+"px",height:s+"px"}),o.css({position:"relative",top:"0px",left:"0px",width:t+"px",height:s+"px"}),e.vCenter={x:t/2,y:s/2},e.update()}).each(function(){this.complete&&t(this).load()}),o.mousewheel(function(t,i){t.preventDefault(),e.options.zoom-=i*e.options.zoomStep,e.update()}),o.mousedown(function(i){function n(i){i.preventDefault(),setTimeout(function(){e.dragging=!1},0),o.unbind("mousemove"),o.unbind("mouseup"),t(document).unbind("mouseup")}i.preventDefault();var s=i;o.mousemove(function(t){t.preventDefault(),e.dragging=!0,e.vCenter.x=e.vCenter.x-(t.pageX-s.pageX)/e.options.zoom,e.vCenter.y=e.vCenter.y-(t.pageY-s.pageY)/e.options.zoom,s=t,e.update()}),t(document).one("mouseup",n),o.one("mouseup",n)}),o.click(function(t){e.dragging||e._trigger("onClick",t,e)}),t(window).resize(function(){e.ready&&(e.vCenter.x*=i.width()/n.width(),e.vCenter.y*=i.height()/n.height(),e.update())})},destroy:function(){var e=t(this.zimg);e.unbind("click"),e.unmousewheel(),t(window).unbind("resize"),e.remove(),t(this.view).remove(),t.Widget.prototype.destroy.call(this)},_setOption:function(e,i){switch(e){case"zoom":if(1>parseFloat(i)||isNaN(parseFloat(i)))return;break;case"zoomStep":if(0>=parseFloat(i)||isNaN(parseFloat(i)))return}var o=t.ui.version.split(".");switch(o[0]>1||o[1]>8?this._super(e,i):t.Widget.prototype._setOption.apply(this,arguments),e){case"zoom":this.ready&&this.update()}},addElem:function(e){t(this.view).append(e)},isVisible:function(t,e){var i=this.getView();return i?t>=i.left&&i.right>=t&&e>=i.top&&i.bottom>=e:!1},getView:function(){if(this.ready){var e=t(this.img),i=e.width(),o=e.height(),n=this.options.zoom;return{top:this.vCenter.y/o-.5/n,left:this.vCenter.x/i-.5/n,bottom:this.vCenter.y/o+.5/n,right:this.vCenter.x/i+.5/n}}return null},panTo:function(e,i){if(this.ready&&e>=0&&1>=e&&i>=0&&1>=i){var o=t(this.img),n=o.width(),s=o.height();return this.vCenter.x=e*n,this.vCenter.y=i*s,this.update(),{x:this.vCenter.x/n,y:this.vCenter.y/s}}return null},imgToView:function(e,i){if(this.ready&&e>=0&&1>=e&&i>=0&&1>=i){var o=t(this.img),n=o.width(),s=o.height(),r=n/2-this.vCenter.x*this.options.zoom,h=s/2-this.vCenter.y*this.options.zoom,p=e*n*this.options.zoom+r,a=i*s*this.options.zoom+h;return{x:Math.round(p),y:Math.round(a)}}return null},imgToCursor:function(e,i){var o=this.imgToView(e,i);if(o){var n=t(this.img).offset();return o.x+=n.left+this.offsetBorder.x+this.offsetPadding.left,o.y+=n.top+this.offsetBorder.y+this.offsetPadding.top,o}return null},viewToImg:function(e,i){if(this.ready){var o=t(this.img),n=o.width(),s=o.height(),r=n/2-this.vCenter.x*this.options.zoom,h=s/2-this.vCenter.y*this.options.zoom,p=(e-r)/(n*this.options.zoom),a=(i-h)/(s*this.options.zoom);return p>=0&&1>=p&&a>=0&&1>=a?{x:p,y:a}:null}return null},cursorToImg:function(e,i){if(this.ready){var o=t(this.img),n=o.width(),s=o.height(),r=o.offset(),h=n/2-this.vCenter.x*this.options.zoom,p=s/2-this.vCenter.y*this.options.zoom,a=(e-r.left-this.offsetBorder.x-this.offsetPadding.left-h)/(n*this.options.zoom),d=(i-r.top-this.offsetBorder.y-this.offsetPadding.top-p)/(s*this.options.zoom);return a>=0&&1>=a&&d>=0&&1>=d?{x:a,y:d}:null}return null},update:function(){if(this.ready){var e,i,o,n,s=t(this.img),r=s.width(),h=s.height(),p=s.offset(),a=this.options.zoom,d=r/2,u=h/2;1>=a?(e=0,i=0,o=r,n=h,this.vCenter={x:d,y:u},this.options.zoom=1):(e=Math.round(u-this.vCenter.y*a),i=Math.round(d-this.vCenter.x*a),o=Math.round(r*a),n=Math.round(h*a),i>0?(this.vCenter.x=d/a,i=0):r>i+o&&(this.vCenter.x=r-d/a,i=r-o),e>0?(this.vCenter.y=u/a,e=0):h>e+n&&(this.vCenter.y=h-u/a,e=h-n));var f=Math.round(p.top+this.offsetBorder.y+this.offsetPadding.top),g=Math.round(p.left+this.offsetBorder.x+this.offsetPadding.left);t(this.view).css({top:f+"px",left:g+"px",width:r+"px",height:h+"px"}),t(this.zimg).css({left:i+"px",top:e+"px",width:o+"px",height:n+"px"}),this._trigger("onUpdate",null,this)}}})})(jQuery);