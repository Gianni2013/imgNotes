/*! jQuery imgNotes - v0.6.0 - 2013-06-09
* https://github.com/waynegm/imgNotes
* Copyright (c) 2013 Wayne Mogg; Licensed MIT */
(function(t){t.widget("wgm.imgNotes",{options:{zoom:1,zoomStep:.1,canEdit:!1,vAll:"middle",hAll:"middle",onAdd:function(){return this.options.vAll="bottom",this.options.hAll="middle",t(document.createElement("span")).addClass("marker black").html(this.noteCount)},onEdit:function(e,i){var o=t(i);return t("#NoteDialog").remove(),t('<div id="NoteDialog"></div>').dialog({title:"Note Editor",resizable:!1,modal:!0,height:"300",width:"450",position:{my:"left bottom",at:"right top",of:i},buttons:{Save:function(){var e=t("textarea",this).val();o.data("note",e),t(this).dialog("close")},Delete:function(){o.trigger("remove"),t(this).dialog("close")},Cancel:function(){t(this).dialog("close")}},open:function(){t(this).css("overflow","hidden");var e=t('<textarea id="txt" style="height:100%; width:100%;">');t(this).html(e),e.val(o.data("note"))}})},onShow:function(e,i){var o=t(i);return t("#NoteDialog").remove(),t('<div id="NoteDialog"></div>').dialog({modal:!1,resizable:!1,height:300,width:250,position:{my:"left bottom",at:"right top",of:i},buttons:{Close:function(){t(this).dialog("close")}},open:function(){t(this).html(o.data("note")),t(this).closest(".ui-dialog").find(".ui-dialog-titlebar:first").hide()},close:function(){t(this).dialog("remove")}})}},_create:function(){var e=this;this.element.is("img")||t.error("imgNotes plugin can only be applied to img elements"),e.notes=[],e.noteCount=0,e.img=e.element[0];var i=t(e.img);i.imgViewer({onClick:function(t,i){if(e.options.canEdit){t.preventDefault();var o=i.cursorToImg(t.pageX,t.pageY);if(o){var a=e.addNote(o.x,o.y);e._trigger("onEdit",t,a)}}},onUpdate:function(){t.each(e.notes,function(){e._updateMarkerPos(this)})}})},destroy:function(){this.clear(),t(this.img).imgViewer("destroy"),t.Widget.prototype.destroy.call(this)},_setOption:function(e,i){switch(e){case"vAll":switch(i){case"top":break;case"bottom":break;default:i="middle"}break;case"hAll":switch(i){case"left":break;case"right":break;default:i="middle"}}var o=t.ui.version.split(".");switch(o[0]>1||o[1]>8?this._super(e,i):t.Widget.prototype._setOption.apply(this,arguments),e){case"zoom":t(this.img).imgViewer("option","zoom",i);break;case"zoomStep":t(this.img).imgViewer("option","zoomStep",i)}},addNote:function(e,i,o){var a=this;this.noteCount++;var n=this.options.onAdd.call(this),s=t(n);switch(t(this.img).imgViewer("addElem",n),s.data("relx",e).data("rely",i).data("note",o),this.options.vAll){case"top":s.data("yOffset",0);break;case"bottom":s.data("yOffset",s.height());break;default:s.data("yOffset",Math.round(s.height()/2))}switch(this.options.hAll){case"left":s.data("xOffset",0);break;case"right":s.data("xOffset",s.width());break;default:s.data("xOffset",Math.round(s.width()/2))}return s.click(function(t){t.preventDefault(),a.options.canEdit?a._trigger("onEdit",t,n):a._trigger("onShow",t,n)}),s.on("remove",function(){a._delete(n)}),this._updateMarkerPos(n),this.notes.push(n),n},count:function(){return this.noteCount},_updateMarkerPos:function(e){var i=t(e),o=t(this.img),a=o.imgViewer("imgToView",i.data("relx"),i.data("rely"));a&&i.css({left:a.x-i.data("xOffset"),top:a.y-i.data("yOffset"),position:"absolute"})},_delete:function(e){this.notes=this.notes.filter(function(t){return t!==e}),t(e).remove()},clear:function(){var e=this;t.each(e.notes,function(){var e=t(this);e.remove()}),e.notes=[],e.noteCount=0},"import":function(e){var i=this;t.each(e,function(){i.addNote(this.x,this.y,this.note)})},"export":function(){var e=[];return t.each(this.notes,function(){var i=t(this);e.push({x:i.data("relx"),y:i.data("rely"),note:i.data("note")})}),e}})})(jQuery);